<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Times Tables SRS</title>
<style>
:root{
 --bg:#0f1115;--panel:#171a21;--ink:#e8ecf1;--muted:#a7b0bd;--accent:#58a6ff;
 --good:#2ea043;--bad:#f85149;--warn:#d29922;--shadow:0 8px 30px rgba(0,0,0,.35)
}
@media(prefers-color-scheme:light){
 :root{--bg:#f6f8fa;--panel:#fff;--ink:#0a0c10;--muted:#5a646f;--accent:#0969da;
 --good:#1a7f37;--bad:#d1242f;--warn:#9a6700;--shadow:0 8px 24px rgba(0,0,0,.12)}
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
background:var(--bg);color:var(--ink);padding:16px;touch-action:manipulation}
.card{background:var(--panel);border-radius:16px;box-shadow:var(--shadow);
padding:18px;margin-bottom:12px}
h1{margin:0 0 6px;font-size:22px}
button,select,input{font-size:17px;border-radius:12px;min-height:44px}
button{background:var(--accent);color:#fff;border:none;padding:10px 14px;cursor:pointer}
button.ghost{background:transparent;color:var(--accent)}
button.good{background:var(--good)}button.bad{background:var(--bad)}button.warn{background:var(--warn)}
select,input{border:1px solid #0002;padding:10px 12px}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;position:sticky;top:0;z-index:10;background:var(--bg);padding-bottom:6px}
.bigQ{font-size:48px;font-weight:800;text-align:center;margin:10px 0}
.choices{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
.choices button{min-width:110px;font-size:22px}
.answerRow{display:flex;gap:8px;justify-content:center;align-items:center}
.answerRow input{font-size:28px;text-align:center;width:150px}
.stat{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
.center{text-align:center}.hint{font-size:13px;color:var(--muted)}
textarea{width:100%;min-height:140px;padding:10px;border-radius:10px;border:1px solid #0002;background:#0001;color:var(--ink);font-size:14px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);padding:16px;z-index:30}
.modal .sheet{background:var(--panel);padding:16px;border-radius:16px;max-width:900px;max-height:85vh;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px 10px;border-bottom:1px solid #0002;text-align:left}
tr.badrow td{background:rgba(248,81,73,.08)}
</style>
</head>
<body>

<div class="controls">
 <h1 class="grow">Times Tables SRS</h1>
 <label>Profile</label><select id="profileSelect"></select>
 <button id="addProfileBtn" class="ghost">Ôºã</button>
 <button id="delProfileBtn" class="ghost">üóë</button>
 <label>Table</label><select id="tableSize"><option value="10">10√ó10</option><option value="12" selected>12√ó12</option></select>
 <label>Mode</label><select id="modeSelect"><option value="typing" selected>Typing</option><option value="mc">Multiple</option></select>
 <label>Timer</label><select id="timerSelect"><option value="off">Off</option><option value="5">5 s</option><option value="10">10 s</option></select>
 <button id="startBtn">Start / Continue</button>
</div>

<div class="stat card center">
 <div>Due now: <span id="dueNow">‚Äì</span></div>
 <div>Answered today: <span id="ansToday">‚Äì</span></div>
 <div>Accuracy: <span id="accRate">‚Äì</span></div>
 <div>Next due: <span id="nextDueIn">‚Äì</span></div>
</div>

<!-- Quiz -->
<div id="quizCard" class="card" style="display:none">
 <div class="bigQ" id="question">3√ó4=?</div>
 <div id="typingRow" class="answerRow">
  <input id="answerInput" type="number" inputmode="numeric"><button id="submitBtn">Check</button>
  <button id="dontKnowBtn" class="ghost">I don‚Äôt know</button>
 </div>
 <div id="choicesRow" class="choices" style="display:none"></div>
 <div class="center" style="margin-top:8px">
  <button id="pauseBtn" class="ghost">Pause</button>
  <button id="stopBtn" class="ghost">Stop</button>
 </div>
</div>

<!-- Done -->
<div id="doneCard" class="card" style="display:none;text-align:center">
 <div class="bigQ">üéâ All caught up!</div>
 <div class="hint" id="doneHint">No cards due.</div>
 <button id="practiceAnywayBtn" class="ghost">Practice anyway</button>
</div>

<!-- Tools -->
<div class="card">
 <button id="dailyReportBtn" class="ghost">Daily report</button>
 <button id="deckReportBtn" class="ghost">Deck report</button>
 <button id="resetBtn" class="warn">Reset deck</button>
 <button id="exportBtn" class="ghost">Export</button>
 <button id="importBtn" class="ghost">Import</button>
 <div id="ioBox" style="display:none;margin-top:10px">
  <textarea id="ioText"></textarea>
  <div class="center" style="margin-top:8px">
   <button id="ioClose" class="ghost">Close</button>
  </div>
 </div>
</div>

<!-- Modals -->
<div id="dailyModal" class="modal"><div class="sheet">
 <h2>Daily report</h2><button id="closeDaily" class="ghost">Close</button>
 <div id="dailySummary" class="hint"></div>
 <table><thead><tr><th>Time</th><th>Q</th><th>Your</th><th>Ans</th></tr></thead><tbody id="mistakesTable"></tbody></table>
</div></div>

<div id="deckModal" class="modal"><div class="sheet">
 <h2>Deck report</h2><button id="closeDeck" class="ghost">Close</button>
 <table><thead><tr><th>Q</th><th>Streak</th><th>Ease</th><th>Int</th><th>Due</th></tr></thead><tbody id="deckTable"></tbody></table>
</div></div>

<script>
/* ======== BASIC HELPERS ======== */
const LS_BASE='ttsrs-v8';const LS_PROFILES_LIST='ttsrs-profiles-list';const LS_CURRENT_PROFILE='ttsrs-current';
let currentProfile=null;
function storageKeyFor(p){return`${LS_BASE}::${p}`;}
function loadProfilesList(){try{return JSON.parse(localStorage.getItem(LS_PROFILES_LIST)||'[]')||[]}catch{return[]}}
function saveProfilesList(a){localStorage.setItem(LS_PROFILES_LIST,JSON.stringify(a))}
function setCurrentProfile(n){currentProfile=n;localStorage.setItem(LS_CURRENT_PROFILE,n)}
function getCurrentProfile(){return localStorage.getItem(LS_CURRENT_PROFILE)}
function daySerial(){return Math.floor(Date.now()/86400000)}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.random()*(i+1)|0;[a[i],a[j]]=[a[j],a[i]]}}
/* ======== STATE ======== */
const state={size:12,facts:[],firstPassQueue:[],stats:{lastDay:daySerial(),answeredToday:0,correctToday:0,badAnswersToday:{},logsToday:[]},settings:{mode:'typing',timer:'off'}};
/* ======== INIT PROFILE ======== */
function ensureProfile(){
 let list=loadProfilesList();let cur=getCurrentProfile();
 if(!list.length){list=['Player 1'];saveProfilesList(list);setCurrentProfile('Player 1');}
 else if(!cur||!list.includes(cur)) setCurrentProfile(list[0]);
 currentProfile=getCurrentProfile();
}
function save(){localStorage.setItem(storageKeyFor(currentProfile),JSON.stringify(state))}
function load(){
 const raw=localStorage.getItem(storageKeyFor(currentProfile));if(!raw)return false;
 Object.assign(state,JSON.parse(raw));return true;
}
/* ======== DECK ======== */
function resetDeck(size){
 state.size=size;state.facts=[];
 for(let a=1;a<=size;a++)for(let b=1;b<=size;b++)state.facts.push({a,b,dueDay:daySerial(),streak:0,ease:2.5,interval:1,timesSeen:0,totalCorrect:0,totalWrong:0});
 state.firstPassQueue=Array.from(state.facts.keys());shuffle(state.firstPassQueue);
 state.stats={lastDay:daySerial(),answeredToday:0,correctToday:0,badAnswersToday:{},logsToday:[]};
 save();
}
function pickNext(dueOnly=true){
 const today=daySerial();
 if(state.firstPassQueue.length){shuffle(state.firstPassQueue);const idx=state.firstPassQueue[0];return idx;}
 const due=state.facts.map((f,i)=>({i,due:f.dueDay})).filter(x=>!dueOnly||x.due<=today);
 if(!due.length)return -1;shuffle(due);return due[0].i;
}
/* ======== SRS LOGIC ======== */
function updateSRS(correct,val){
 const idx=currentIdx;if(idx<0)return;const f=state.facts[idx];const today=daySerial();
 if(state.firstPassQueue[0]===idx)state.firstPassQueue.shift();
 f.timesSeen++;
 if(correct){
  f.streak++;
  if(f.streak===1)f.interval=1;else if(f.streak===2)f.interval=2;else if(f.streak===3)f.interval=3;
  else f.interval=Math.min(Math.round(f.interval*1.3+1),10);
  f.ease=Math.min(3,+(f.ease+0.02).toFixed(2));
  f.dueDay=today+f.interval;f.totalCorrect++;
 }else{
  f.streak=0;f.ease=Math.max(1.3,+(f.ease-0.1).toFixed(2));f.interval=0;f.dueDay=today;f.totalWrong++;
 }
 state.stats.answeredToday++;if(correct)state.stats.correctToday++;
 state.stats.logsToday.push({t:new Date().toLocaleTimeString(),q:`${f.a}√ó${f.b}`,correct,val});
 save();
}
/* ======== UI ======== */
function countDue(){return state.facts.filter(f=>f.dueDay<=daySerial()).length}
function renderStats(){
 document.getElementById('dueNow').textContent=countDue();
 document.getElementById('ansToday').textContent=state.stats.answeredToday;
 const a=state.stats.answeredToday,c=state.stats.correctToday;
 document.getElementById('accRate').textContent=a?Math.round(100*c/a)+'%':'‚Äì';
 const nd=state.facts.reduce((m,f)=>Math.min(m,f.dueDay),1e9)-daySerial();
 document.getElementById('nextDueIn').textContent=nd<=0?'now':nd+' d';
}
function updateDoneMsg(){
 const n=countDue();const hint=document.getElementById('doneHint');
 if(n>0){hint.textContent=`${n} cards remaining.`}else hint.textContent='No cards due.';
}
/* ======== QUIZ ======== */
let currentIdx=-1;
function showCard(i){
 currentIdx=i;const f=state.facts[i];
 document.getElementById('quizCard').style.display='';
 document.getElementById('doneCard').style.display='none';
 document.getElementById('question').textContent=`${f.a}√ó${f.b}=?`;
 const typingRow=document.getElementById('typingRow'),choices=document.getElementById('choicesRow');
 if(state.settings.mode==='typing'){typingRow.style.display='';choices.style.display='none';
  document.getElementById('answerInput').value='';}
 else{typingRow.style.display='none';choices.style.display='';buildChoices(f);}
}
function buildChoices(f){
 const correct=f.a*f.b;let opts=[correct];
 const pool=[correct+1,correct-1,correct+f.a,correct-f.b].filter(x=>x>0);
 shuffle(pool);for(const p of pool){if(opts.length<3&&!opts.includes(p))opts.push(p);}
 shuffle(opts);
 const r=document.getElementById('choicesRow');r.innerHTML='';
 opts.forEach(v=>{
  const b=document.createElement('button');b.textContent=v;
  b.onclick=()=>{
   const ok=v===correct;updateSRS(ok,v);
   b.classList.add(ok?'good':'bad');
   setTimeout(()=>step(),ok?300:600);
  };
  r.appendChild(b);
 });
}
function step(){
 renderStats();
 const idx=pickNext(true);
 if(idx>=0)showCard(idx);
 else{document.getElementById('quizCard').style.display='none';
  document.getElementById('doneCard').style.display='';
  updateDoneMsg();}
}
/* ======== EVENTS ======== */
document.getElementById('startBtn').onclick=()=>{
 if(!state.facts.length)resetDeck(+document.getElementById('tableSize').value);
 step();
};
document.getElementById('submitBtn').onclick=()=>{
 const f=state.facts[currentIdx];const v=+document.getElementById('answerInput').value;
 const ok=v===f.a*f.b;updateSRS(ok,v);setTimeout(()=>step(),ok?250:600);
};
document.getElementById('dontKnowBtn').onclick=()=>{updateSRS(false,NaN);step();};
document.getElementById('pauseBtn').onclick=()=>alert('Pause not needed now ‚Äì timer feature trimmed.');
document.getElementById('stopBtn').onclick=()=>{
 document.getElementById('quizCard').style.display='none';
 document.getElementById('doneCard').style.display='';updateDoneMsg();
};
document.getElementById('practiceAnywayBtn').onclick=()=>{
 const i=pickNext(false);if(i>=0)showCard(i);
};
/* Reports */
document.getElementById('dailyReportBtn').onclick=()=>{
 const tb=document.getElementById('mistakesTable');tb.innerHTML='';
 state.stats.logsToday.forEach(l=>{if(!l.correct){tb.innerHTML+=`<tr class=badrow><td>${l.t}</td><td>${l.q}</td><td>${l.val}</td><td>${eval(l.q)}</td></tr>`}});
 document.getElementById('dailyModal').style.display='flex';
};
document.getElementById('deckReportBtn').onclick=()=>{
 const tb=document.getElementById('deckTable');tb.innerHTML='';
 state.facts.forEach(f=>{tb.innerHTML+=`<tr><td>${f.a}√ó${f.b}</td><td>${f.streak}</td><td>${f.ease.toFixed(2)}</td><td>${f.interval}</td><td>${f.dueDay-daySerial()}</td></tr>`});
 document.getElementById('deckModal').style.display='flex';
};
document.getElementById('closeDaily').onclick=()=>document.getElementById('dailyModal').style.display='none';
document.getElementById('closeDeck').onclick=()=>document.getElementById('deckModal').style.display='none';
/* Reset */
document.getElementById('resetBtn').onclick=()=>{if(confirm('Reset deck?')){resetDeck(+document.getElementById('tableSize').value);step();}};
/* Import/Export */
const ioBox=document.getElementById('ioBox'),ioText=document.getElementById('ioText');
document.getElementById('exportBtn').onclick=()=>{
 ioBox.style.display='';ioText.value=JSON.stringify(state,null,2);
 ioText.placeholder=`Exported JSON for ${currentProfile}`;ioText.scrollTop=0;ioText.select();
};
document.getElementById('importBtn').onclick=()=>{
 ioBox.style.display='';ioText.value='';
 ioText.placeholder=`Paste JSON for ${currentProfile}, then press ‚ÄúImport now‚Äù.`;
 const footer=ioBox.querySelector('div.center');
 footer.innerHTML=`<button id=confirmImport class=good>Import now</button> <button id=cancelImport class=ghost>Cancel</button>`;
 document.getElementById('confirmImport').onclick=()=>{
  try{const obj=JSON.parse(ioText.value);
   if(!Array.isArray(obj.facts))throw'Invalid JSON';
   localStorage.setItem(storageKeyFor(currentProfile),JSON.stringify(obj));load();
   alert('Import OK');ioBox.style.display='none';renderStats();updateDoneMsg();step();
  }catch(e){alert('Import failed '+e)}
 };
 document.getElementById('cancelImport').onclick=()=>ioBox.style.display='none';
};
document.getElementById('ioClose').onclick=()=>ioBox.style.display='none';
/* Profiles */
const sel=document.getElementById('profileSelect');
function refreshProfiles(){
 const list=loadProfilesList();sel.innerHTML='';list.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;if(n===currentProfile)o.selected=true;sel.appendChild(o)});
 document.getElementById('delProfileBtn').disabled=list.length<=1;
}
sel.onchange=()=>{save();setCurrentProfile(sel.value);if(!load())resetDeck(+document.getElementById('tableSize').value);renderStats();updateDoneMsg();step();};
document.getElementById('addProfileBtn').onclick=()=>{
 const name=prompt('New profile name:','Player '+(loadProfilesList().length+1));
 if(!name)return;const list=loadProfilesList();if(list.includes(name))return alert('Exists');
 list.push(name);saveProfilesList(list);setCurrentProfile(name);resetDeck(12);refreshProfiles();step();
};
document.getElementById('delProfileBtn').onclick=()=>{
 const list=loadProfilesList();if(list.length<=1)return alert('Need at least one.');
 if(!confirm('Delete '+currentProfile+'?'))return;
 localStorage.removeItem(storageKeyFor(currentProfile));
 const newList=list.filter(x=>x!==currentProfile);saveProfilesList(newList);setCurrentProfile(newList[0]);load()||resetDeck(12);refreshProfiles();step();
};
/* Init */
(function(){
 ensureProfile();if(!load())resetDeck(12);refreshProfiles();renderStats();updateDoneMsg();
})();
</script>
</body>
</html>
